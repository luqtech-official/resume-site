---
import Layout from '../layouts/Layout.astro';
import ScriptListItem from '../components/ScriptListItem.astro';
import ScriptModal from '../components/ScriptModal.astro';

const scripts = await Astro.glob('../data/trading-scripts/*.md');
---

<Layout title="Open-Sourced Trading Scripts">
  <div class="page-header">
    <div class="header-content">
      <h1><br />Luq Technology Project Showcase</h1>
      <p>Selected open-source projects built by me for TradingView Community.</p>
    </div>
  </div>

  <section class="portfolio-highlight">
    <div class="tv-profile-card">
      <div class="tv-header">
        <span class="tv-logo">TradingView</span>
        <h3 class="tv-logo">@fareidzulkifli</h3>
      </div>
      <p>Top-rated Pine Script Developer with a focus on institutional-grade tools.</p>
      <div class="tv-stats">
        <span><strong>High Reputation</strong> in Community</span>
        <span><strong>2,000+</strong> Boosts</span>
      </div>
      <a href="https://www.tradingview.com/u/fareidzulkifli/#published-scripts" target="_blank" class="btn">View Full Profile on TradingView</a>
    </div>
  </section>

  <div class="forum-container">
    <div class="forum-toolbar">
      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="script-search" placeholder="Search scripts by title or description..." />
      </div>
      <div class="spacer"></div>
      <span class="result-count"><span id="filtered-count">{scripts.length}</span> Scripts</span>
    </div>

    <div class="scripts-list" id="scripts-list">
      {scripts.map((script, index) => {
          const modalId = `script-modal-${index}`;
          return (
              <ScriptListItem
                  title={script.frontmatter.title}
                  description={script.frontmatter.description}
                  image={script.frontmatter.image}
                  modalId={modalId}
                  index={index}
              />
          );
      })}
    </div>
  </div>

  {/* Render Modals */}
  {scripts.map((script, index) => {
      const modalId = `script-modal-${index}`;
      const { Content } = script;
      return (
          <ScriptModal 
            id={modalId} 
            title={script.frontmatter.title}
            image={script.frontmatter.image}
            fullDescription={script.frontmatter.fullDescription}
          >
              <Content />
          </ScriptModal>
      );
  })}
</Layout>

<script>
  // Search Logic
  const searchInput = document.getElementById('script-search') as HTMLInputElement;
  const scriptRows = document.querySelectorAll('.script-row');
  const filteredCount = document.getElementById('filtered-count');

  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      let visibleCount = 0;

      scriptRows.forEach((row) => {
        const title = row.querySelector('.script-title')?.textContent?.toLowerCase() || '';
        const desc = row.querySelector('.script-desc')?.textContent?.toLowerCase() || '';
        
        if (title.includes(query) || desc.includes(query)) {
          (row as HTMLElement).style.display = 'flex';
          visibleCount++;
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });

      if (filteredCount) {
        filteredCount.textContent = visibleCount.toString();
      }
    });
  }

  // Modal Logic
  const dialogs = document.querySelectorAll('dialog');
  dialogs.forEach(dialog => {
      dialog.addEventListener('close', () => {
          document.body.style.overflow = '';
      });
      
      dialog.addEventListener('click', (e) => {
          const rect = dialog.getBoundingClientRect();
          const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height
            && rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
          if (!isInDialog) {
              dialog.close();
          }
      });
  });

  document.addEventListener('click', (e) => {
    // Type assertion for cleaner TS usage
    const target = e.target as HTMLElement;
    
    // Find trigger
    const btnTrigger = target.closest('.view-script-btn');
    
    if (btnTrigger) {
        const modalId = btnTrigger.getAttribute('data-modal-id');
        e.preventDefault(); 
        
        if (modalId) {
            const modal = document.getElementById(modalId) as HTMLDialogElement;
            if (modal) {
                modal.showModal();
                document.body.style.overflow = 'hidden';
            }
        }
    }
  });
</script>

<style>
  .page-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }
  
  .page-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: var(--color-text-main);
    font-weight: 300;
  }
  
  .page-header p {
      color: var(--color-text-muted);
      font-weight: 300;
      font-size: 1.1rem;
  }

  .portfolio-highlight {
    margin-bottom: 2rem;
  }

  .tv-profile-card {
    background: var(--color-tv-black);
    color: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }

  .tv-header {
    margin-bottom: 1rem;
  }

  .tv-logo {
    display: block;
    font-weight: 700;
    color: var(--color-tv-green);
    margin-bottom: 0.5rem;
  }

  .tv-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 1rem 0;
    font-size: 0.9rem;
  }

  .forum-container {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    margin-bottom: 4rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
  }

  .forum-toolbar {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid var(--color-border);
    gap: 1rem;
    font-size: 0.9rem;
  }

  .search-wrapper {
    display: flex;
    align-items: center;
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.4rem 0.75rem;
    flex-grow: 1;
    max-width: 400px;
  }

  .search-icon {
    font-size: 0.9rem;
    margin-right: 0.5rem;
    opacity: 0.5;
  }

  #script-search {
    border: none;
    outline: none;
    width: 100%;
    font-size: 0.9rem;
    color: var(--color-text-main);
    background: transparent;
  }

  #script-search::placeholder {
    color: var(--color-text-muted);
    opacity: 0.7;
  }

  .spacer {
    flex-grow: 1;
  }

  .result-count {
    color: var(--color-text-muted);
    font-size: 0.8rem;
  }

  .scripts-list {
    display: flex;
    flex-direction: column;
  }
</style>
